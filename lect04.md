Виртуальные машины. Лекция 4

* Некоторые техники используемые в сборщиках мусора

    Сборка мусора, вообще говоря, долгая и дорогая операция. Как можно оптимизировать этот процесс, используя гипотезу поколений? Ну собирать только в одном поколении, где и плодятся быстроживущие объекты. С точки зрения анализа достижимости, нам надо как-то поделить граф объектов на старые и молодые объекты. Вот как понять, что объект в малом поколении и надо осуществить так называемую "малую сборку". Стандартная техника - сжать видение старого поколения до уровня "где есть ссылки в молодое поколение". То есть когда в старике появляется ссылка на молодой объект, то этот факт можно и запомнить. (upd 13.10.2016) - это не правда, битовый массив создается для старого поколения. Грубо говоря, видим в молодняке ссылку в стариков - туда не идем

    Где-то в памяти лежит битсет, который помечает дополнительные элементы в корневом наборе, представляя факт, что все объекты в некотором диапазоне имеют ссылку. В виртуальных машинах распростанены операции барьера чтения и записи - если пишем ссылку, то выставляем битик в битсете. В хотспоте чаще используют барьеры записи(дешевле). Кстати говоря, адрес объекта - величина непостоянная. В хипе есть диапазон адресов для старого и молодого поколения, который относительно фиксирован(это к тому, как понять в каком поколении лежит объект). Кроме того, это хорошо с точки зрения кэшей процессора

    Еще один вопрос, в том, что для того чтобы хорошо собрать мусор нам все же придется остановить мир. Для этого надо остановить все потоки программы. Вопрос первый, как оставить потоки в консистентном состоянии? Вопрос второй, что такое консистентное состояние? Есть две техники реализации остановки мира - преемпитивная и кооперативная. В хотспоте выбрана полукооперативная стратегия остановки мира. В местах, где все более или менее конситентно вставляется специальная инструкция - чтения из предопределенного места в памяти. Тогда можно выставить у этой страницы флаг, что читать из нее нельзя и все потоки окажутся в состоянии, что им нужно обработать ошибку чтения из запрещенной области. Все повисли --- та-дам!

    При остановке мира считается количество потоков, которые нужно остановить.

* Сжатые указатели

    Немного про реализацию указателей в хотспоте. Мотивация в том, что указатели на 64 бита - большие и можно адресовать много объектов. Однако и места они занимают больше. Люди пришли к мысли, что можно обойтись и меньшим количеством бит. Мысль в том, что минимальная адресуемая единица - байт. Ну так давайте увеличивать гранулярность, тогда мы сможем адресовать больше памяти. В хотспоте представляют указатели в виде 32-битных значений. Трюк следующий - база + скалируемое смещение + оффсет. В качестве базы - база хипа, например. Все бы хорошо, но с нулевым указателем возникает проблема(потому что в качестве объекта для разыменования получается база хипа). В хотспоте при этом получается запрет на чтение из базы хипа(по прерыванию или еще как-то).

  <!-- Тут я перестал улавливать мысли Иготти и перестал записывать =( -->
